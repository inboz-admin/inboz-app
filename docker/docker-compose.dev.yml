services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: inboz-mysql-dev
    restart: unless-stopped
    ports:
      - "3320:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - app-network

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: inboz-redis-dev
    restart: unless-stopped
    ports:
      - "6379:6379"  # Expose Redis externally
    volumes:
      - redis_data:/data
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    healthcheck:
      test: ["CMD", "sh", "-c", "redis-cli $${REDIS_PASSWORD:+-a $$REDIS_PASSWORD} ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      sh -c "if [ -n \"$$REDIS_PASSWORD\" ]; then
        redis-server --requirepass $$REDIS_PASSWORD --appendonly yes
      else
        redis-server --appendonly yes
      fi"
    networks:
      - app-network

  # NestJS Backend Server (API)
  server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.server
      target: development
    container_name: inboz-server-dev
    restart: unless-stopped
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: ${NODE_ENV}
      APP_NAME: ${APP_NAME}
      APP_URL: ${APP_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_URL: ${REDIS_URL}
      BULL_BOARD_USERNAME: ${BULL_BOARD_USERNAME:-admin}
      BULL_BOARD_PASSWORD: ${BULL_BOARD_PASSWORD:-admin}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION}
      JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      UPLOAD_MAX_SIZE: ${UPLOAD_MAX_SIZE}
      UPLOAD_DEST: ${UPLOAD_DEST}
      UPLOAD_PATH: ${UPLOAD_PATH}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE}
      MAX_FILES: ${MAX_FILES}
      BASE_URL: ${BASE_URL}
      RAZOR_PAY_KEY: ${RAZOR_PAY_KEY}
      RAZOR_PAY_SECRET: ${RAZOR_PAY_SECRET}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FILE: ${LOG_FILE}
      CORS_ORIGIN: ${CORS_ORIGIN}
    volumes:
      - uploads_data:/usr/src/app/uploads
      - logs_data:/usr/src/app/logs
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4000/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - app-network

  # BullMQ Worker (processes background jobs)
  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.server
      target: development
    container_name: inboz-worker-dev
    restart: unless-stopped
    command: ["sh", "-c", "sleep 30 && npm run start:worker"]
    # Simple health check: verify Node.js worker process is running
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node.*worker.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      NODE_ENV: ${NODE_ENV}
      APP_NAME: ${APP_NAME}
      APP_URL: ${APP_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_URL: ${REDIS_URL}
      BULL_BOARD_USERNAME: ${BULL_BOARD_USERNAME:-admin}
      BULL_BOARD_PASSWORD: ${BULL_BOARD_PASSWORD:-admin}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION}
      JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      UPLOAD_MAX_SIZE: ${UPLOAD_MAX_SIZE}
      UPLOAD_DEST: ${UPLOAD_DEST}
      UPLOAD_PATH: ${UPLOAD_PATH}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE}
      MAX_FILES: ${MAX_FILES}
      BASE_URL: ${BASE_URL}
      RAZOR_PAY_KEY: ${RAZOR_PAY_KEY}
      RAZOR_PAY_SECRET: ${RAZOR_PAY_SECRET}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FILE: ${LOG_FILE}
      CORS_ORIGIN: ${CORS_ORIGIN}
    volumes:
      - uploads_data:/usr/src/app/uploads
      - logs_data:/usr/src/app/logs
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      server:
        condition: service_started
    networks:
      - app-network

  # Scheduler (cron jobs - only ONE instance should run)
  scheduler:
    build:
      context: ..
      dockerfile: docker/Dockerfile.server
      target: development
    container_name: inboz-scheduler-dev
    restart: unless-stopped
    command: ["sh", "-c", "sleep 30 && npm run start:scheduler"]
    # Simple health check: verify Node.js scheduler process is running
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node.*scheduler.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      NODE_ENV: ${NODE_ENV}
      APP_NAME: ${APP_NAME}
      APP_URL: ${APP_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_URL: ${REDIS_URL}
      BULL_BOARD_USERNAME: ${BULL_BOARD_USERNAME:-admin}
      BULL_BOARD_PASSWORD: ${BULL_BOARD_PASSWORD:-admin}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION}
      JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      UPLOAD_MAX_SIZE: ${UPLOAD_MAX_SIZE}
      UPLOAD_DEST: ${UPLOAD_DEST}
      UPLOAD_PATH: ${UPLOAD_PATH}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE}
      MAX_FILES: ${MAX_FILES}
      BASE_URL: ${BASE_URL}
      RAZOR_PAY_KEY: ${RAZOR_PAY_KEY}
      RAZOR_PAY_SECRET: ${RAZOR_PAY_SECRET}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FILE: ${LOG_FILE}
      CORS_ORIGIN: ${CORS_ORIGIN}
      BOUNCE_DETECTION_INTERVAL: ${BOUNCE_DETECTION_INTERVAL:-}
      REPLY_DETECTION_INTERVAL: ${REPLY_DETECTION_INTERVAL:-}
    volumes:
      - uploads_data:/usr/src/app/uploads
      - logs_data:/usr/src/app/logs
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      server:
        condition: service_started
    networks:
      - app-network

  # React Frontend UI
  ui:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ui
      target: development
    container_name: inboz-ui-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: ${NODE_ENV}
      VITE_API_BASE_URL: ${VITE_API_BASE_URL}
      VITE_APP_NAME: ${VITE_APP_NAME}
      VITE_APP_ENV: ${VITE_APP_ENV}
      VITE_ENABLE_DEBUG: ${VITE_ENABLE_DEBUG}
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/', (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - app-network

volumes:
  mysql_data:
  redis_data:
  uploads_data:
  logs_data:

networks:
  app-network:
    driver: bridge
